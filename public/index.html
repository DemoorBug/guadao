<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>市场价格可视化</title>
    <style>
      body { font-family: -apple-system, system-ui, Segoe UI, Roboto, Helvetica, Arial; margin: 24px; }
      .container { max-width: 1080px; margin: 0 auto; }
      canvas { width: 100%; height: 480px; }
      .toolbar { display: flex; gap: 12px; align-items: center; margin-bottom: 16px; }
      select, button { padding: 6px 10px; }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Steam / Buff 价格趋势</h1>
      <div class="toolbar">
        <label>
          物品：
          <select id="itemSelect"></select>
        </label>
        <button id="refreshBtn">刷新</button>
      </div>
      <canvas id="chart"></canvas>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/luxon@3/build/global/luxon.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon"></script>
    <script>
      async function loadData() {
        const res = await fetch('../data/data.json', { cache: 'no-cache' });
        return await res.json();
      }

      function buildSeries(history, itemId, key) {
        return history.map(s => {
          const it = s.items.find(x => x.id === itemId);
          return it ? { x: s.timestamp, y: it[key] } : { x: s.timestamp, y: null };
        });
      }

      async function init() {
        const history = await loadData();
        const allItemIds = Array.from(new Set(history.flatMap(s => s.items.map(i => i.id))));
        const select = document.getElementById('itemSelect');
        select.innerHTML = allItemIds.map(id => `<option value="${id}">${id}</option>`).join('');
        const ctx = document.getElementById('chart');
        const chart = new Chart(ctx, {
          type: 'line',
          data: { datasets: [] },
          options: {
            responsive: true,
            parsing: false,
            scales: {
              x: { type: 'time', time: { tooltipFormat: 'yyyy-MM-dd HH:mm' } },
              y: { beginAtZero: false }
            },
            interaction: { intersect: false, mode: 'index' },
            plugins: { legend: { position: 'top' } }
          }
        });

        function render() {
          const id = select.value;
          chart.data.datasets = [
            { label: 'Buff', data: buildSeries(history, id, 'buffPrice'), borderColor: '#0ea5e9', spanGaps: true },
            { label: 'Steam', data: buildSeries(history, id, 'steamPrice'), borderColor: '#f59e0b', spanGaps: true }
          ];
          chart.update();
        }
        select.addEventListener('change', render);
        document.getElementById('refreshBtn').addEventListener('click', async () => {
          const h = await loadData();
          history.splice(0, history.length, ...h);
          render();
        });
        render();
      }
      init();
    </script>
  </body>
</html>


